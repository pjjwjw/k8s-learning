[kubeAPIServer, err := CreateKubeAPIServer(kubeAPIServerConfig, apiExtensionsServer.GenericAPIServer)](https://github.com/pjjwjw/kubernetes/blob/88c6ea125f001c612b800d028d7ccfe908aa5082/cmd/kube-apiserver/app/server.go#L207)

[kubeAPIServer, err := kubeAPIServerConfig.Complete().New(delegateAPIServer)](https://github.com/pjjwjw/kubernetes/blob/88c6ea125f001c612b800d028d7ccfe908aa5082/cmd/kube-apiserver/app/server.go#L228)

[s, err := c.GenericConfig.New("kube-apiserver", delegationTarget)](https://github.com/pjjwjw/kubernetes/blob/d2abddd9096e30a6c47c72e3e43a033e99c1c149/pkg/controlplane/instance.go#L349)

[New](https://github.com/pjjwjw/kubernetes/blob/b604a6669b439205d3425749530620ff903312dd/vendor/k8s.io/apiserver/pkg/server/config.go#L567)

```golang
handlerChainBuilder := func(handler http.Handler) http.Handler {
    return c.BuildHandlerChainFunc(handler, c.Config)
}
apiServerHandler := NewAPIServerHandler(name, c.Serializer, handlerChainBuilder, delegationTarget.UnprotectedHandler())
s := &GenericAPIServer{
    ...
    Handler: apiServerHandler,
    ...
}
```

c.BuildHandlerChainFunc初始化:
[BuildHandlerChainFunc: DefaultBuildHandlerChain](https://github.com/pjjwjw/kubernetes/blob/b604a6669b439205d3425749530620ff903312dd/vendor/k8s.io/apiserver/pkg/server/config.go#L331)

[handler = genericapifilters.WithAuthentication(handler, c.Authentication.Authenticator, failedHandler, c.Authentication.APIAudiences)](https://github.com/pjjwjw/kubernetes/blob/b604a6669b439205d3425749530620ff903312dd/vendor/k8s.io/apiserver/pkg/server/config.go#L792)


[withAuthentication](https://github.com/pjjwjw/kubernetes/blob/b604a6669b439205d3425749530620ff903312dd/vendor/k8s.io/apiserver/pkg/endpoints/filters/authentication.go#L45)
``` golang
func withAuthentication(handler http.Handler, auth authenticator.Request, failed http.Handler, apiAuds authenticator.Audiences, metrics recordMetrics) http.Handler {
    if auth == nil {
        klog.Warning("Authentication is disabled")
        return handler
    }
    // 这里为了便于理解把源码做了修改
    f := func(w http.ResponseWriter, req *http.Request) {
        authenticationStart := time.Now()

        if len(apiAuds) > 0 {
            req = req.WithContext(authenticator.WithAudiences(req.Context(), apiAuds))
        }
        resp, ok, err := auth.AuthenticateRequest(req)
        // auth等于c.Authentication.Authenticator, 赋值的位置为:
        // https://github.com/kubernetes/kubernetes/blob/34b0fcef5fc47e3fcddf7f6ca1b3e6176b2a5323/pkg/kubeapiserver/authenticator/config.go#L213
        // authenticator := union.New(authenticators...)
        authenticationFinish := time.Now()
        defer func() {
            metrics(req.Context(), resp, ok, err, apiAuds, authenticationStart, authenticationFinish)
        }()
        if err != nil || !ok {
            if err != nil {
                klog.ErrorS(err, "Unable to authenticate the request")
            }
            failed.ServeHTTP(w, req)
            return
        }

        if !audiencesAreAcceptable(apiAuds, resp.Audiences) {
            err = fmt.Errorf("unable to match the audience: %v , accepted: %v", resp.Audiences, apiAuds)
            klog.Error(err)
            failed.ServeHTTP(w, req)
            return
        }

        // authorization header is not required anymore in case of a successful authentication.
        req.Header.Del("Authorization")

        req = req.WithContext(genericapirequest.WithUser(req.Context(), resp.User))
        handler.ServeHTTP(w, req)
    }
    // f是func(ResponseWriter, *Request)类型, http.HandlerFunc(f)将f转换成了HandlerFunc, 该类型实现了Handler接口
    // 假设handler:=withAuthentication(...), 那么调用handler.ServeHTTP(w, r)等价于调用f(w, r)
    return http.HandlerFunc(f)
}


// HandlerFunc定义:
// The HandlerFunc type is an adapter to allow the use of
// ordinary functions as HTTP handlers. If f is a function
// with the appropriate signature, HandlerFunc(f) is a
// Handler that calls f.
type HandlerFunc func(ResponseWriter, *Request)

// ServeHTTP calls f(w, r).
func (f HandlerFunc) ServeHTTP(w ResponseWriter, r *Request) {
    f(w, r)
}

// handle 定义
// A Handler responds to an HTTP request.
//
// ServeHTTP should write reply headers and data to the ResponseWriter
// and then return. 
type Handler interface {
    ServeHTTP(ResponseWriter, *Request)
}
```
