- [1. 注册资源](#1-注册资源)
  - [1.1. 代码](#11-代码)
- [2. cobra参数解析](#2-cobra参数解析)
- [3. 创建apiserver通用配置](#3-创建apiserver通用配置)
  - [3.1. genericConfig实例化](#31-genericconfig实例化)
  - [3.2. openapi/swagger配置](#32-openapiswagger配置)
  - [3.3. etcd配置](#33-etcd配置)
  - [3.4. 认证配置](#34-认证配置)
    - [3.4.1. 代码](#341-代码)
  - [3.5. 授权配置](#35-授权配置)
  - [3.6. 准入控制器配置](#36-准入控制器配置)

# 1. 注册资源

apiserver启动的第一步是注册资源

apiserver通过go语言的import init机制资源注册至scheme

每个内置的资源都有一个install包, 导入这个包就可以把资源注册到scheme中

scheme中包含了两个map, 实现了资源的struct reflect.type到gvk的双向映射

有三种scheme， 内置资源(pod / service)注册至legacyscheme，聚合资源(metrice service)资源注册至aggregatorscheme, 拓展资源(crd / crdList)注册至extensionscheme.

## 1.1. 代码

a. [import app](https://github.com/pjjwjw/kubernetes/blob/master/cmd/kube-apiserver/apiserver.go#L28) ->

a.1. regist to legacyscheme: [import controlplane package](https://github.com/pjjwjw/kubernetes/blob/master/cmd/kube-apiserver/app/server.go#37) -> [import install package](https://github.com/pjjwjw/kubernetes/blob/master/pkg/controlplane/import_known_versions.go)

a.2. [regist to extensionscheme](https://github.com/pjjwjw/kubernetes/blob/master/cmd/kube-apiserver/app/server.go#L35)

a.3. [regist to aggregatorscheme](https://github.com/pjjwjw/kubernetes/blob/master/cmd/kube-apiserver/app/server.go#67)

# 2. cobra参数解析
初始化各个模块的参数配置: [s := options.NewServerRunOptions()](https://github.com/pjjwjw/kubernetes/blob/master/cmd/kube-apiserver/app/server.go#L100)

填充默认配置参数: [completedOptions, err := Complete(s)](https://github.com/pjjwjw/kubernetes/blob/master/cmd/kube-apiserver/app/server.go#L132)

校验参数的合法性: [errs := completedOptions.Validate()](https://github.com/pjjwjw/kubernetes/blob/master/cmd/kube-apiserver/app/server.go#L138)

将参数传给Run函数: [Run(completedOptions, genericapiserver.SetupSignalHandler())](https://github.com/pjjwjw/kubernetes/blob/master/cmd/kube-apiserver/app/server.go#L142)

# 3. 创建apiserver通用配置
## 3.1. genericConfig实例化
[command := app.NewAPIServerCommand()](https://github.com/pjjwjw/kubernetes/blob/88c6ea125f001c612b800d028d7ccfe908aa5082/cmd/kube-apiserver/apiserver.go#L32) -> 

[Run(completedOptions, genericapiserver.SetupSignalHandler())](https://github.com/pjjwjw/kubernetes/blob/88c6ea125f001c612b800d028d7ccfe908aa5082/cmd/kube-apiserver/app/server.go#L142) ->

[server, err := CreateServerChain(completeOptions, stopCh)](https://github.com/pjjwjw/kubernetes/blob/88c6ea125f001c612b800d028d7ccfe908aa5082/cmd/kube-apiserver/app/server.go#L174) ->

[kubeAPIServerConfig, serviceResolver, pluginInitializer, err := CreateKubeAPIServerConfig(completedOptions)](https://github.com/pjjwjw/kubernetes/blob/88c6ea125f001c612b800d028d7ccfe908aa5082/cmd/kube-apiserver/app/server.go#L189) ->

[enericConfig, versionedInformers, serviceResolver, pluginInitializers, admissionPostStartHook, storageFactory, err := buildGenericConfig(s.ServerRunOptions, proxyTransport)](https://github.com/pjjwjw/kubernetes/blob/88c6ea125f001c612b800d028d7ccfe908aa5082/cmd/kube-apiserver/app/server.go#L257) ->

实例化: [genericConfig = genericapiserver.NewConfig(legacyscheme.Codecs)](https://github.com/pjjwjw/kubernetes/blob/88c6ea125f001c612b800d028d7ccfe908aa5082/cmd/kube-apiserver/app/server.go#L376)

设置启用的资源, 默认启用v1 beta, 不启用alpha: [genericConfig.MergedResourceConfig = controlplane.DefaultAPIResourceConfigSource()](https://github.com/pjjwjw/kubernetes/blob/88c6ea125f001c612b800d028d7ccfe908aa5082/cmd/kube-apiserver/app/server.go#L377)

## 3.2. openapi/swagger配置
genericConfig.OpenAPIConfig用于生成OpenAPI规范, generatedopenapi.GetOpenAPIDefinitions由openapi-gen自动生成

[getOpenAPIDefinitions := openapi.GetOpenAPIDefinitionsWithoutDisabledFeatures(generatedopenapi.GetOpenAPIDefinitions)<br>genericConfig.OpenAPIConfig = genericapiserver.DefaultOpenAPIConfig(getOpenAPIDefinitions, openapinamer.NewDefinitionNamer(legacyscheme.Scheme, extensionsapiserver.Scheme, aggregatorscheme.Scheme))](https://github.com/pjjwjw/kubernetes/blob/88c6ea125f001c612b800d028d7ccfe908aa5082/cmd/kube-apiserver/app/server.go#L400)


## 3.3. etcd配置
storageFactoryConfig定义了与apiserver与etcd交互的方式:

[storageFactoryConfig := kubeapiserver.NewStorageFactoryConfig()](https://github.com/pjjwjw/kubernetes/blob/88c6ea125f001c612b800d028d7ccfe908aa5082/cmd/kube-apiserver/app/server.go#L412)

## 3.4. 认证配置
认证的作用是证明客户端的身份

apiserver提供了9种认证器, 分别是ClientCA / TokenAuth / ServiceAccountAuth ...

根据配置信息决定启用哪种认证器, 并将认证器加入认证器列表, 最后将证器列表包装起来并返回

请求到达apiserver时会遍历认证器列表, 只要有一个认证通过, 则通过.

### 3.4.1. 代码

[if lastErr = s.Authentication.ApplyTo(&genericConfig.Authentication, genericConfig.SecureServing, genericConfig.EgressSelector, genericConfig.OpenAPIConfig, clientgoExternalClient, versionedInformers); lastErr != nil {
		return
}](https://github.com/pjjwjw/kubernetes/blob/88c6ea125f001c612b800d028d7ccfe908aa5082/cmd/kube-apiserver/app/server.go#L451) ->

[authInfo.Authenticator, openAPIConfig.SecurityDefinitions, err = authenticatorConfig.New()](https://github.com/pjjwjw/kubernetes/blob/ef2be5586eb2cc80fe619da81daa994dec9bf49e/pkg/kubeapiserver/options/authentication.go#L506) ->

包装认证器列表: [authenticator := union.New(authenticators...)<br>authenticator = group.NewAuthenticatedGroupAdder(authenticator)](https://github.com/pjjwjw/kubernetes/blob/34b0fcef5fc47e3fcddf7f6ca1b3e6176b2a5323/pkg/kubeapiserver/authenticator/config.go#L213)

处理认证请求: [AuthenticateRequest](https://github.com/pjjwjw/kubernetes/blob/b604a6669b439205d3425749530620ff903312dd/vendor/k8s.io/apiserver/pkg/authentication/request/union/union.go#L53)

``` golang
func (authHandler *unionAuthRequestHandler) AuthenticateRequest(req *http.Request) (*authenticator.Response, bool, error) {
	var errlist []error
	for _, currAuthRequestHandler := range authHandler.Handlers {
		resp, ok, err := currAuthRequestHandler.AuthenticateRequest(req)
		if err != nil {
			if authHandler.FailOnError {
				return resp, ok, err
			}
			errlist = append(errlist, err)
			continue
		}

		if ok {
			return resp, ok, err
		}
	}

	return nil, false, utilerrors.NewAggregate(errlist)
}
```

## 3.5. 授权配置

## 3.6. 准入控制器配置